% -*-latex-*-

\chapter{Helicity Decoder}
\label{A2}

In \Cref{C5S1SS2}, we have discussed the helicity scheme of the experiment E08-027. During the experiment, the helicity scheme is determined by the Hall C QWEAK experiment with a high reversal rate at 960.02 Hz. The typical DAQ rate of E08-027 is $5\sim6$ kHz. The existed helicity decoder for QWEAK helicity scheme (THaQWEAKHelicity in the Hall A analyzer package) requires the DAQ rate to be lower than 100 Hz \cite{Hansen2015}, thus this decoder could not be used in E08-027. A new helicity decoder is designed for experiment E08-027. In this section, we will discuss the algorithm used by this new decoder and the test results.

\section{Data Acquisition Setup}
\label{A2S1}

To calculate asymmetry, each recorded event need to be sorted by the helicity of the electron beam. The number of accepted events in each helicity state is normalized by the total charge from BCM and the DAQ live time with the same helicity. Thus, the BCM signal, the triggers (T1$\sim$T8) and L1A signal of Hall A DAQ also need to be sorted by the beam helicity. In experiment E08-027, these signals and the detected physical event are addressed as two different issues.

The helicity signals described in \Cref{C5S1SS2} are copied to three different electronics during E08-027. The helicity of the physical event is recorded by the trigger interface (TI). The TI has 12 state registers (TIR). Four of these registers are used to record all of the four helicity signals respectively. The electronics setup is based on the Ref. \cite{Michaels2010} and the recorded helicity is referred as TIR helicity in the rest of this article. Besides, decoding the TIR helicity requires timing information. The standard 103.7 kHz fast clock signal of Hall A is used to set a timestamp for each physical event.

The BCM signals, triggers and L1A signals are all pulse signals. The helicity-gated SIS3801 scalers are used in the experiment to count these signals. \Cref{A2S1F1} shows the workflow of a SIS3801 scaler. The scaler contains 32 data registers to count, 8 control registers and a FIFO (First-In-First-Out) data buffer. The data signals are sent to the data registers and the $\tsettles$ signal (See \Cref{C5S1F2}) is sent to one of the control registers to make a veto gate. The data registers only count during the $\tstable$ part of a helicity window. Once the counting of one helicity window is finished, the FIFO read the counting results and save them temporally. Two additional control registers are used to record the Delayed Helicity and Pattern Sync signals. The FIFO also reads them and records the helicity state of each helicity window.

\begin{figure}[tb!]
  \centering
  \includegraphics[width=0.8\textwidth]{figs/sis3801.png}
  \caption{Workflow of a SIS3801 scaler. \label{A2S1F1}}
\end{figure}

However, the FIFO is not capable to store a large amount of data. A ring buffer, which is able to store the counting results of 1000 helicity windows, is set in the memory of the VME crate to keep the counting results. The ring buffer is read by the DAQ system every 50 physical events to reduce DAQ dead time. After each readout, the ring buffer is cleared for new counting results. With SIS3801 scalers, the helicity-gated counting results is saved to the raw data file marked with their helicity. The helicity recorded by the ring buffer is referred as ring buffer helicity in the rest of this article.

\section{Helicity Decoder}
\label{A2S2}

As mentioned in \Cref{C5S1SS2}, the helicity received by the experimental halls is delayed by 8 helicity windows. In the accelerator injector, the beam helicity is determined by a pseudo-random generator which is shown in \Cref{A2S2F1}. Since the algorithm of this pseudo-random generator is well defined, the actual helicity can be extracted via the same pseudo-random algorithm. The idea is to read 30 continuous helicity patterns to retrieve the random seed, and use this seed to predict the reported helicity, i.e. the delayed helicity as well as the actual helicity. The prediction is compared to the reported helicity of the first window of each pattern in the helicity sequence to make sure it is correct.

\begin{figure}[b!]
  \centering
  \includegraphics[width=0.8\textwidth]{figs/helicity-pseudo-random.png}
  \caption[The pseudo-random generator of the helicity signal.]{The 30-bit shift register in the Helicity Control Board. The polarity of a new pattern is calculated by applying an XOR (exclusive disjunction) operation to the bit 30, bit 29, bit 28 and bit 7 of a 30-bit register. Then the register is left-shifted by one bit and the new bit 1 is set by the XOR result. The repeat length of this generator is $2^{30} - 1 = 1,073,741,823$ bits. \label{A2S2F1}}
\end{figure}

\subsection{Predict Actual Ring Buffer Helicity}
\label{A2S2SS1}

The ring buffer saves a full sequence of the helicity as mentioned in \Cref{A2S1}. The sequence only breaks if no event written during the time period of 1000 helicity windows that in our case is about a second. It is because the capacity of the ring buffer is 1000 helicity windows, and the newly coming data flushes the old one out if DAQ system does not read the ring buffer to clear it.

The method of decoding the ring buffer helicity is shown in \Cref{A2S2F2}. If the random seed is not set, the program reads the ring buffer helicity in sequence and selects out the windows with Pattern Sync 1. The helicities of these windows are appended to the random seed. The seed is used to predict the reported helicity and the actual helicity of the next helicity pattern once 30 bits is collected. For a Quartet pattern (``$+--\,+$'' or ``$-++\,-$''), only the helicity of the first window is directly predicted by the seed. The helicities of the second and the third window are always opposite to the first window and the helicity of the forth window is equal to the first one. After prediction of four windows in one pattern, the random seed is left-shifted by one bit and the new bit 1 is set with the reported helicity of the first window of the predicted pattern. The prediction is verified with the reported helicity sequence. If the prediction fails for any reason, each window in this failed pattern is marked as bad and the random seed is reset immediately and generate again.

\begin{figure}[tb!]
  \centering
  \includegraphics[width=\textwidth]{figs/ring-buffer-helicity.png}
  \caption[Predict actual ring buffer helicity.]{Predict actual ring buffer helicity. The windows marked as yellow are used to generate the random seed. The seed is used to predict the reported helicity and the actual helicity of the newly coming window (marked as cyan). In this example, the reported helicity of the cyan window is 1 but the actual helicity is 0. \label{A2S2F2}}
\end{figure}

\subsection{Predict Actual TIR Helicity}
\label{A2S2SS2}

For TIR helicity, the decoding algorithm is still based on the prediction method. However, it is possible that several raw events are saved in one helicity window, or no physical event is saved during several helicity windows. \Cref{A2S2F3} shows an example of TIR helicity. It does not show any obvious pattern, which makes the decoding more difficult. It is critical to find a method to locate each event in the helicity sequence before any prediction can be proceed. Since the helicity windows all have identical time length, it is possible to identify each raw event in the helicity sequence if they are labeled by some kind of timestamp. Therefore a 103.9 kHz fast clock signal is used to set the timestamp during the experiment. The clock signal is counted by an ungated scaler (which means it is not helicity gated), and read by the DAQ system for each event. The helicity reversal frequency is 960.02 Hz in the experiment, so the time length of each window is about $\tw=103900\divisionsymbol960.02\approx108.2$ scaler counts. Some of the TIR event may be saved during the $\tsettle$ part of a helicity window. These events is excluded from the decoding process and marked as ``unstable'' by the decoder.

\begin{figure}[tb!]
  \centering
  \includegraphics[width=\textwidth]{figs/tir-helicity.png}
  \caption[An example of the TIR helicity.]{An example of the TIR helicity. The sequence on the top is the normal helicity sequence. The physical event stream at the bottom shows how the TIR helicity breaks the normal helicity sequence. \label{A2S2F3}}
\end{figure}

The first step to decode the TIR helicity is still to generate the random seed. For convenience, the helicity windows with Pattern Sync 1 are referred as Pattern Sync windows in the rest of this article. Any events in these Pattern Sync windows are also referred as Pattern Sync events. The helicity of Pattern Sync events is used to generate the random seed, however, there are 3 different situations for the TIR helicity:
\begin{enumerate}[parsep=0pt]
\item \label{A2S2A1} The event is the first event of a Pattern Sync window, and no Pattern Sync window is missed before this event. In this case, the helicity of this event should be appended to the random seed.
\item The event is the second (or third, ...) event of a Pattern Sync window. In this case it is ignored because the first event of this window has been appended to the random seed.
\item \label{A2S2A2} One or more Pattern Sync windows are missed before this event. In this case, the existed bits of the random seed is reset.
\end{enumerate}
In the decoder, the time interval $\dtpat$ is calculated to determine these 3 situations. Assuming the timestamp of the current event is $T$ and the previous Pattern Sync event is $\tlastpat$, $\dtpat$ can be expressed as $\dtpat=T-\tlastpat$. \Cref{A2S2F4} shows the restrictions on $\dtpat$ for these 3 situations. If $\dtpat<2\tw$, the previous Pattern Sync event and the new one are in the same window, and it is case \ref{A2S2A1} described above. If $\dtpat>6\tw$, at least one Pattern Sync window is missed, and this is case \ref{A2S2A2}. Notice that the possible value of $\dtpat$ are $0\sim1\tw$, $3\sim5\tw$, $7\sim9\tw$ or etc. The restrictions are chosen to be just inbetween two ranges to avoid any possible error due to the scaler fluctuation.

\begin{figure}[tb!]
  \centering
  \includegraphics[width=0.85\textwidth]{figs/tir-helicity-seed.png}
  \caption[Determine the radom seed for TIR helicity.]{Restrictions on $\dtpat$ to determine whether a Pattern Sync window is missed or not if the new event is a Pattern Sync event. Here $\tw$ is the time length of a helicity window in the unit of scaler counts. The red arrows are different possibilities of the previous event. \label{A2S2F4}}
\end{figure}

Once the random seed is generated, the second step is to predict the reported and actual helicity for each event with the seed. Since the random seed need to be left-shifted by 1 bit whenever a helicity pattern is finished, it is critical to determine $n$, the number of missed Pattern Sync windows. Besides $\dtpat$, another time interval $\dt$ is used to determine $n$. Assuming the timestamp of the previous event is $\tlast$, $\dt$ can be expressed as $\dt=T-\tlast$. The random seed is left-shifted by $n$ bits before the prediction. When shifting, the new bits are always calculated with the algorithm in \Cref{A2S2F1}. Due to the particularity of the Pattern Sync event, three different situations need to be considered separately:
\begin{enumerate}[parsep=0pt]
\item \label{A2S2A3} Both the new event and its previous event are Pattern Sync events. In this case, the restrictions on $\dtpat$ shown in \Cref{A2S2F4} still works. If $\dtpat<2\tw$, the new event is in the same window of the previous one. The same random seed is used to predict the actual helicity. If $(4\times n+2)\tw<\dtpat<(4\times n+6)\tw$, $n$ Pattern Sync windows are missed ($n$ can be 0). After prediction, the seed is left-shifted by 1 bits to prepare for next prediction.
\item \label{A2S2A4} The new event is a Pattern Sync event but its previous event is not one. In this case, the time interval $\dt$ is used to determine the number of missed Pattern Sync windows. The integer part of $\dt/(4\tw)$ is $n$. After prediction, the seed is left-shifted by 1 bits to prepare for next prediction.
\item The new event is not a Pattern Sync event. In this case, the time interval $\dtpat$ is used to determine the number of missed Pattern Sync windows. The integer part of $\dtpat/(4\tw)$ is $n$. The prediction only tells the actual helicity of the first window in this Quartet pattern. The actual helicity of this particular event can be found in \Cref{A2S2T1} according to its Pair Sync and reported helicity value. Unlike case \ref{A2S2A3} and \ref{A2S2A4}, the seed does not need to be left-shifted after prediction, but the $\tlastpat$ need to be increased by $n\times4\tw$ in case the next event is still not a Pattern Sync event.
\end{enumerate}

\begin{table}[b!]
  \centering
  \newcolumntype{C}[1]{>{\centering\arraybackslash}m{#1}}
  \begin{tabular}{|*{6}{C{2.0cm}|}}
    \hline
    \multicolumn{3}{|c|}{Prediction of the First Window is $+$} & \multicolumn{3}{c|}{Prediction of the First Window is $-$} \\ \hline
    Reported Helicity & Pair Sync & Actual Helicity & Reported Helicity & Pair Sync &Actual Helicity\\ \hline
    1 & 1 & $+$ & 0 & 1 & $-$ \\ \hline
    0 & 0 & $-$ & 1 & 0 & $+$ \\ \hline
    0 & 1 & $-$ & 1 & 1 & $+$ \\ \hline
    1 & 0 & $+$ & 0 & 0 & $-$ \\ \hline
  \end{tabular}
  \caption[The corresponding actual helicity for a helicity pattern.]{Find the actual helicity of a event according to its reported helicity and Pair Sync value. \label{A2S2T1}}
\end{table}

\Cref{A2S2F5} shows how to set restrictions on $\dt$ and $\dtpat$ to determine $n$ for these 3 situations. The prediction of the reported helicity of each event is checked with the reported helicity written in the raw data file. If the prediction fails, any events in this pattern are marked as bad. The random seed is reset and regenerated.

\begin{figure}[tb!]
  \centering
  {\includegraphics[width=\textwidth]{figs/tir-helicity-prediction-a.png} \phantomsubcaption{\label{A2S2F5a}}}
  {\includegraphics[width=\textwidth]{figs/tir-helicity-prediction-b.png} \phantomsubcaption{\label{A2S2F5b}}}
  {\includegraphics[width=\textwidth]{figs/tir-helicity-prediction-c.png} \phantomsubcaption{\label{A2S2F5c}}}
  \captionsetup{skip=0ex}
  \caption[Predict actual TIR helicity.]{Restrictions to determine the number of missed Pattern Sync windows: (\subref{A2S2F5a}) Both the new event and its previous event are Pattern Sync events; (\subref{A2S2F5b}) The new event is a Pattern Sync event but its previous event is not one; (\subref{A2S2F5c}) The new event is not a Pattern Sync event. \label{A2S2F5}}
\end{figure}

Due to the fluctuation of the scaler, the time interval $\dt$ and $\dtpat$ may not satisfy the restrictions described above sometimes. The excluded $\tsettles$ events is used to calibrate $\tlast$ and $\tlastpat$ since the time length of helicity windows is quite accurate. As shown in \Cref{A2S2F6}, a $\tsettles$ event which is right before a Pattern Sync window is selected out for calibration. Assuming the timestamp of this $\tsettles$ event is $T$, the $\tlast$ is set to $T-\tw$ and the $\tlastpat$ is set to $T-3\tw$. Once calibrated, $\tlast$ and $\tlastpat$ are not used to store the time stamp of previous events any more. The values of $\tlast$ and $\tlastpat$ are increased by $n\times4\tw$ if $n$ patterns are finished during the prediction. And any qualified $\tsettles$ events are used to recalibrate their values. The fluctuation of $\dt$ and $\dtpat$ is reduced by half at least if calculated with calibrated $\tlast$ and $\tlastpat$ and hence the number of missed Pattern Sync windows can be determined more accurately.

\begin{figure}[b!]
  \centering
  \includegraphics[width=0.5\textwidth]{figs/tir-helicity-tsettle-calibration.png}
  \caption{Calibrate $\tlast$ and $\tlastpat$ with $\tsettles$ events. \label{A2S2F6}}
\end{figure}

\subsection{Align TIR Helicity with Ring Buffer Helicity}
\label{A2S2SS3}

The purpose to align TIR helicity with ring buffer helicity is to insert the helicity-gated informations into the physical data stream. As mentioned in \Cref{A2S2F1}, the helicity random seed never repeats during one particular run, so it can be used as ``fingerprint'' to do this alignment.

Before alignment, the quality of the prediction result is checked to avoid false asymmetry. If the actual helicity of a event is not predictable due to some error, events in the same helicity pattern are also marked as bad during the checking. For the ring buffer helicity, the BCM information is used to determine beam trips. The data taken during the beam trip and within 30 helicity patterns before or after the beam trip is excluded from the data analysis to prevent any systematic error.

\begin{figure}[b!]
  \centering
  \includegraphics[width=\textwidth]{figs/helicity-align.png}
  \caption[Align TIR helicity with ring buffer helicity.]{Align TIR helicity with ring buffer helicity. Take BCM as an example of the helicity-gated data. The second pattern in the helicity sequence missed two 0 helicity windows, so the BCM values of this pattern is added to the values of next pattern to be saved in the physical event stream. \label{A2S2F7} }
\end{figure}

\Cref{A2S2F7} shows an example of the alignment. Here BCM is selected as an example of the helicity-gated data. For each helicity pattern in the ring buffer helicity, two BCM values $C_{+}$ and $C_{-}$ are calculated for $+$ and $-$ helicity. The random seed saved for this pattern is compared with all the random seeds saved in the tir helicity. If a matching pattern is found and the pattern contains at least one event with $+$ helicity and one event with $-$ helicity, $C_{+}$ is saved to the first event with $+$ helicity and $C_{-}$ is saved to the first event with $-$ helicity. If no pattern matches, $C_{+}$ and $C_{-}$ is added to the BCM values of the next helicity pattern in the ring buffer helicity. This method keeps the asymmetry and the sum of each helicity-gated data unchanged in the physical event stream so they can be used in helicity-related calculation.

\section{Test with Charge Asymmetry}
\label{A2S3}

The helicity decoder is tested with beam charge asymmetry during the experiment. The beam charge asymmetry $A_{Q}$ can be expressed as:
\begin{equation} \label{A2S3E1}
A_{Q}=\frac{Q_{+}-Q_{-}}{Q_{+}+Q_{-}}.
\end{equation}
Here $Q_{\pm}$ are the beam charge with helicity $\pm 1$. The beam charge asymmetry can be adjusted in the injector. For the test, beam with large charge asymmetry is required from the injector and is measured with HRS DAQ (SIS3801 scaler), Hall A M{\o}ller DAQ and Hall C DAQ simultaneously. The M{\o}ller DAQ and Hall C DAQ is used as reference of this test. The results of the test are listed in \Cref{A2S3T1}. The calculation result of the new helicity decoder agrees with the M{\o}ller DAQ and Hall C DAQ.

\begin{table}[h!]
  \centering
  \begin{tabular}{|*{7}{c|}}
    \hline
    ID & Left HRS & Right HRS & Moller & Hall C \\ \hline
    1 & -0.91\% & -0.91\% & -0.92\% & -0.91\% \\ \hline
    2 & -0.56\% & -0.56\% & -0.56\% & -0.56\% \\ \hline
    3 & -0.092\% & -0.095\% & -0.090\% & -0.094\% \\ \hline
  \end{tabular}
  \caption{Beam charge asymmetry test with different DAQs. \label{A2S3T1}}
\end{table}

\clearpage
\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% -*-latex-*-
